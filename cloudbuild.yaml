options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Fetch the full history to avoid shallow clone issues
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args: ['-c', 'git fetch --unshallow']

  # Check for changes in the summary function
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: check-summary
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Checking for changes in 'summary' folder..."
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          if git diff --quiet HEAD~1 HEAD -- cloudfunctions/summary; then
            echo "No changes in 'summary', skipping deployment."
            touch /workspace/skip-summary  # Create a skip file to indicate no changes
          else
            echo "Changes detected in 'summary'."
          fi
        else
          echo "First commit or no previous commit, proceeding with deployment."
        fi

  # Deploy summary cloud function only if no skip file exists
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: deploy-summary
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f /workspace/skip-summary ]; then
          echo "Skipping 'summary' deployment as no changes were detected."
        else
          echo "Checking the status of the 'summary' cloud function before deploying..."
          max_attempts=6
          attempt=1
          backoff_time=10
          while [ $attempt -le $max_attempts ]; do
            status=$(gcloud functions describe summary --region us-central1 --format="value(status)")
            if [ "$status" == "ACTIVE" ]; then
              echo "'summary' function is ACTIVE. Proceeding with deployment."
              break
            elif [ "$status" == "DEPLOYING" ]; then
              echo "'summary' function is currently DEPLOYING. Retrying in $backoff_time seconds..."
            else
              echo "'summary' function is in status: $status. Retrying in $backoff_time seconds..."
            fi
            sleep $backoff_time
            attempt=$((attempt + 1))
            backoff_time=$((backoff_time * 2))  # Exponential backoff
            if [ $attempt -gt $max_attempts ]; then
              echo "Maximum attempts reached. Exiting deployment."
              exit 1
            fi
          done

          echo "Deploying 'summary' cloud function..."
          cd cloudfunctions/summary
          cp -r ../../utils .  # Copy utils to the function folder
          gcloud functions deploy summary \
            --runtime python310 \
            --entry-point hello_world \
            --trigger-http \
            --region us-central1 \
            --source .
        fi

  # Check for changes in the sentimet function
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: check-sentimet
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Checking for changes in 'sentimet' folder..."
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          if git diff --quiet HEAD~1 HEAD -- cloudfunctions/sentimet; then
            echo "No changes in 'sentimet', skipping deployment."
            touch /workspace/skip-sentimet  # Create a skip file to indicate no changes
          else
            echo "Changes detected in 'sentimet'."
          fi
        else
          echo "First commit or no previous commit, proceeding with deployment."
        fi

  # Deploy sentimet cloud function only if no skip file exists
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: deploy-sentimet
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f /workspace/skip-sentimet ]; then
          echo "Skipping 'sentimet' deployment as no changes were detected."
        else
          echo "Checking the status of the 'sentimet' cloud function before deploying..."
          max_attempts=6
          attempt=1
          backoff_time=10
          while [ $attempt -le $max_attempts ]; do
            status=$(gcloud functions describe sentimet --region us-central1 --format="value(status)")
            if [ "$status" == "ACTIVE" ]; then
              echo "'sentimet' function is ACTIVE. Proceeding with deployment."
              break
            elif [ "$status" == "DEPLOYING" ]; then
              echo "'sentimet' function is currently DEPLOYING. Retrying in $backoff_time seconds..."
            else
              echo "'sentimet' function is in status: $status. Retrying in $backoff_time seconds..."
            fi
            sleep $backoff_time
            attempt=$((attempt + 1))
            backoff_time=$((backoff_time * 2))  # Exponential backoff
            if [ $attempt -gt $max_attempts ]; then
              echo "Maximum attempts reached. Exiting deployment."
              exit 1
            fi
          done

          echo "Deploying 'sentimet' cloud function..."
          cd cloudfunctions/sentimet
          cp -r ../../utils .  # Copy utils to the function folder
          gcloud functions deploy sentimet \
            --runtime python310 \
            --entry-point hello_world \
            --trigger-http \
            --region us-central1 \
            --source .
        fi

timeout: 1200s
